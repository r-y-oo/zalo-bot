from zlapi.models import Message
import json
import os
import requests
import time
from config import ADMIN  # Import danh sÃ¡ch admin tá»« config.py

des = {
    'version': "1.0.2",
    'credits': "Dzi x Mode",
    'description': "Chuyá»ƒn Ä‘á»•i vÄƒn báº£n thÃ nh voice"
}

def handle_spamnd_command(message, message_object, thread_id, thread_type, author_id, client):
    # Kiá»ƒm tra xem ngÆ°á»i gá»­i cÃ³ pháº£i lÃ  admin khÃ´ng
    if author_id not in ADMIN:
        send_error_message(thread_id, thread_type, client, "ğŸš«â›” VIP Access Denied! Báº¡n khÃ´ng cÃ³ quyá»n dÃ¹ng lá»‡nh nÃ y.")
        return

    content = message_object.content.strip()
    command_parts = content.split(maxsplit=1)

    if len(command_parts) < 2:
        send_error_message(thread_id, thread_type, client, "âš ï¸ğŸ’¡ HÆ°á»›ng Dáº«n: Vui lÃ²ng nháº­p ná»™i dung vÃ  sá»‘ láº§n spam.\nVÃ­ dá»¥: `spamnd Con máº¹ mÃ y,10`")
        return

    try:
        text, times = command_parts[1].rsplit(",", 1)
        text = text.strip()
        times = int(times.strip())
    except (ValueError, IndexError):
        send_error_message(thread_id, thread_type, client, "â—â“ Lá»—i CÃº PhÃ¡p: VÃ­ dá»¥ Ä‘Ãºng: `spamnd Con máº¹ mÃ y,10`")
        return

    if not text:
        send_error_message(thread_id, thread_type, client, "âš ï¸ğŸ“ Lá»—i: Ná»™i dung khÃ´ng Ä‘Æ°á»£c Ä‘á»ƒ trá»‘ng.")
        return

    if times <= 0 or times > 10000000000:
        send_error_message(thread_id, thread_type, client, "ğŸš§ğŸ”¢ Giá»›i Háº¡n: Sá»‘ láº§n spam pháº£i tá»« 1 Ä‘áº¿n 10000000000000.")
        return

    # Thá»±c hiá»‡n spam ngay láº­p tá»©c
    for _ in range(times):
        client.send(Message(text=text), thread_id=thread_id, thread_type=thread_type)
        time.sleep(0.1)  # ThÃªm thá»i gian delay giá»¯a má»—i láº§n gá»­i tin nháº¯n (2 giÃ¢y)

    success_message = f" "
    client.send(Message(text=success_message), thread_id=thread_id, thread_type=thread_type)

def send_error_message(thread_id, thread_type, client, error_message="âŒğŸ’¥ Lá»—i Há»‡ Thá»‘ng!"):
    client.send(Message(text=error_message), thread_id=thread_id, thread_type=thread_type)

def process_message(message_object, thread_id, thread_type, author_id, client):
    content = message_object.content.strip()
    command_parts = content.split(maxsplit=1)
    command = command_parts[0].lower()
    commands = get_mitaizl()
    
    if command in commands:
        commands[command](message_object, thread_id, thread_type, author_id, client)
    else:
        send_error_message(thread_id, thread_type, client, "â“ğŸ” Lá»‡nh KhÃ´ng Há»£p Lá»‡!")

def get_mitaizl():
    return {
        'spamnd': handle_spamnd_command  # Thay Ä‘á»•i tá»« 'spvc' sang 'spamnd'
    }
import os
import requests
import json
from datetime import datetime, timedelta
import random
from zlapi import ZaloAPI
from zlapi.models import *
import time
import importlib
import os
import json
import threading
import requests
import re
from datetime import datetime
import urllib.request
from zlapi.models import Message, ThreadType
import random
import threading
from zlapi.models import Mention, Message
from zlapi._message import MultiMention
import sys


config = {
    "name": "taixiu",
    "description": "Play taixiu game with bet and result"
}

cooldown_data = {}
money_file = os.path.join(os.path.dirname(__file__), "money_data.json")
if os.path.exists(money_file):
    with open(money_file, "r") as file:
        money_data = json.load(file)
else:
    money_data = {}

def save_money_data():
    with open(money_file, "w") as file:
        json.dump(money_data, file)

def add_money(user_id, amount):
    if user_id in money_data:
        money_data[user_id] += amount
    else:
        money_data[user_id] = amount
    save_money_data()

def subtract_money(user_id, amount):
    if user_id in money_data:
        money_data[user_id] -= amount
        if money_data[user_id] < 0:
            money_data[user_id] = 0
    save_money_data()

def get_money(user_id):
    return money_data.get(user_id, 0)

def check_cooldown(author_id, job_id):
    if author_id in cooldown_data:
        if job_id in cooldown_data[author_id]:
            if datetime.now() < cooldown_data[author_id][job_id]:
                return True
    return False

def update_cooldown(author_id, job_id):
    if author_id not in cooldown_data:
        cooldown_data[author_id] = {}
    cooldown_data[author_id][job_id] = datetime.now() + timedelta(seconds=60)

jobs = {
    "1": {"name": "lÃ m ngÃ nh", "reward_range": (500000, 700000)},
    "2": {"name": "lÃ m Ã´sin", "reward_range": (15000, 25000)},
    "3": {"name": "lÃ m Ä‘iáº¿m", "reward_range": (700000, 900000)},
    "4": {"name": "bÃ¡n mÃ¡u", "reward_range": (300000, 500000)},
    "5": {"name": "lÃ m thá»£ sá»­a chá»¯a", "reward_range": (100000, 200000)},
    "6": {"name": "lÃ m phá»¥c vá»¥ quÃ¡n Äƒn", "reward_range": (20000, 40000)},
    "7": {"name": "dáº¡y kÃ¨m", "reward_range": (40000, 60000)},
    "8": {"name": "lÃ m báº£o vá»‡", "reward_range": (50000, 90000)},
    "9": {"name": "lÃ m tÃ i xáº¿", "reward_range": (100000, 150000)},
    "10": {"name": "lÃ m nhÃ  bÃ¡o", "reward_range": (200000, 300000)},
}
def get_random_reward(job_id):
    if job_id in jobs:
        min_reward, max_reward = jobs[job_id]['reward_range']
        return random.randint(min_reward, max_reward)
    return 0

def run(client, args, mid, author_id, message, message_object, thread_id, thread_type):
    if not args:
        functions_list = (
            "ğŸ‰ ğ‘ªğ’‚Ìğ’„ ğ’„ğ’‰ğ’–Ì›Ìğ’„ ğ’ğ’‚Ì†ğ’ğ’ˆ ğ’„ğ’Ì ğ’”ğ’‚Ì†Ìƒğ’: ğŸ‰\n\n"
            "ğŸ. ğŸ’° ğ’„ğ’‰ğ’†ğ’„ğ’Œğ’ğ’ğ’ğ’†ğ’š - ğ‘²ğ’Šğ’†Ì‚Ì‰ğ’ ğ’•ğ’“ğ’‚ ğ’”ğ’Ì‚Ì ğ’•ğ’Šğ’†Ì‚Ì€ğ’ ğ’‰ğ’Šğ’†Ì£Ì‚ğ’ ğ’•ğ’‚Ì£ğ’Š ğ’„ğ’–Ì‰ğ’‚ ğ’ƒğ’‚Ì£ğ’\n\n"
            "ğŸ. ğŸ’µ ğ’”ğ’†ğ’•ğ’ğ’ğ’ğ’†ğ’š @ğ’ğ’ˆğ’–Ì›ğ’Ì›Ì€ğ’Š_ğ’…ğ’–Ì€ğ’ğ’ˆ <ğ’”ğ’Ì‚Ì ğ’•ğ’Šğ’†Ì‚Ì€ğ’> - ğ‘«ğ’‚Ì£Ì†ğ’• ğ’”ğ’Ì‚Ì ğ’•ğ’Šğ’†Ì‚Ì€ğ’ ğ’„ğ’‰ğ’ ğ’ğ’ˆğ’–Ì›ğ’Ì›Ì€ğ’Š ğ’…ğ’–Ì€ğ’\n"
            "ğŸ‘. ğŸ“‹ ğ’ğ’‚ğ’ğ’—ğ’Šğ’†ğ’„ - ğ‘¯ğ’Šğ’†Ì‚Ì‰ğ’ ğ’•ğ’‰ğ’ŠÌ£ ğ’…ğ’‚ğ’ğ’‰ ğ’”ğ’‚Ìğ’„ğ’‰ ğ’„ğ’Ì‚ğ’ğ’ˆ ğ’—ğ’Šğ’†Ì£Ì‚ğ’„\n"
            "ğŸ’. ğŸ› ï¸ ğ’ğ’‚ğ’ğ’—ğ’Šğ’†ğ’„ <ğ’”ğ’Ì‚Ì> - ğ‘ªğ’‰ğ’Ì£ğ’ ğ’„ğ’Ì‚ğ’ğ’ˆ ğ’—ğ’Šğ’†Ì£Ì‚ğ’„ ğ’—ğ’‚Ì€ ğ’ğ’‰ğ’‚Ì£Ì‚ğ’ ğ’•ğ’Šğ’†Ì‚Ì€ğ’\n"
            "ğŸ“. ğŸ² ğ’•ğ’‚Ì€ğ’Š/ğ’™ğ’ŠÌ‰ğ’– <ğ’”ğ’Ì‚Ì ğ’•ğ’Šğ’†Ì‚Ì€ğ’ ğ’„ğ’–Ì›ğ’Ì›Ì£ğ’„> - ğ‘«ğ’‚Ì£Ì†ğ’• ğ’„ğ’–Ì›ğ’Ì›Ì£ğ’„ ğ’—ğ’‚Ì€ğ’ ğ’•ğ’‚Ì€ğ’Š ğ’‰ğ’ğ’‚Ì£Ì†ğ’„ ğ’™ğ’ŠÌ‰ğ’–\n\n"
            "ğŸ” ğ‘¯ğ’‚Ìƒğ’š ğ’„ğ’‰ğ’Ì£ğ’ ğ’„ğ’‰ğ’–Ì›Ìğ’„ ğ’ğ’‚Ì†ğ’ğ’ˆ ğ’…ğ’†Ì‚Ì‰ ğ’ƒğ’‚Ì†Ìğ’• ğ’…ğ’‚Ì‚Ì€ğ’–! ğŸš€"
        )
        return client.replyMessage(Message(text=functions_list), message_object, thread_id, thread_type)

    command = args[0].lower()

    if command == "checkmoney":
        user_money = get_money(author_id)
        reply_message = f"ğŸ’³ â€¢ Money Current: {user_money} VND."
        style_checkmoney = MultiMsgStyle([
            MessageStyle(offset=0, length=10, style="font", size="12", auto_format=False),
            MessageStyle(offset=10, length=len(reply_message.encode()) - 10, style="font", size="13", auto_format=False),
            MessageStyle(offset=10, length=len(reply_message.encode()) - 10, style="color", color="#cdd6f4", auto_format=False),
            MessageStyle(offset=11, length=len(reply_message.split(": ")[1].strip()), style="color", color="#a6adc8", auto_format=False)
        ])
        return client.replyMessage(Message(text=reply_message, style=style_checkmoney), message_object, thread_id, thread_type)

    if command == "setmoney":
        if author_id != "8697905534842942934":
            return client.replyMessage(Message(text="Báº¡n khÃ´ng cÃ³ quyá»n sá»­ dá»¥ng lá»‡nh nÃ y."), message_object, thread_id, thread_type)

        if len(args) < 2 or not message_object.mentions:
            return client.replyMessage(Message(text="CÃº phÃ¡p khÃ´ng Ä‘Ãºng. Vui lÃ²ng sá»­ dá»¥ng: !setmoney @ngÆ°á»i_dÃ¹ng <sá»‘ tiá»n>"), message_object, thread_id, thread_type)

        mentioned_user = message_object.mentions[0]
        user_id = mentioned_user['uid']
        try:
            amount_str = args[-1].replace(",", "").replace(".", "")
            amount = int(amount_str)
            add_money(user_id, amount)
            reply_message = f"â€¢ Added amount {amount} VND for user id: {user_id}."
            style_setmoney = MultiMsgStyle([
                MessageStyle(offset=0, length=10, style="font", size="12", auto_format=False),
                MessageStyle(offset=10, length=len(reply_message.encode()) - 10, style="font", size="13", auto_format=False)
            ])
            return client.replyMessage(Message(text=reply_message, style=style_setmoney), message_object, thread_id, thread_type)
        except ValueError:
            return client.replyMessage(Message(text="Sá»‘ tiá»n khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p má»™t sá»‘."), message_object, thread_id, thread_type)

    if command == "lamviec":
        if len(args) != 2 or args[1] not in jobs:
            job_options = "\n".join([f"{k}: {v['name']}" for k, v in jobs.items()])
            return client.replyMessage(Message(text=f"Vui lÃ²ng chá»n má»™t cÃ´ng viá»‡c:\n{job_options}"), message_object, thread_id, thread_type)

        job_id = args[1]
        if check_cooldown(author_id, job_id):
            return client.replyMessage(Message(text="Báº¡n pháº£i chá» 60 giÃ¢y Ä‘á»ƒ lÃ m cÃ´ng viá»‡c nÃ y láº¡i."), message_object, thread_id, thread_type)

        update_cooldown(author_id, job_id)
        job_name = jobs[job_id]['name']
        job_reward = get_random_reward(job_id)
        add_money(author_id, job_reward)
        reply_message = f"â€¢ báº¡n Ä‘Ã£ {job_name} vÃ  nháº­n Ä‘Æ°á»£c {job_reward} VND."
        style_lamviec = MultiMsgStyle([
            MessageStyle(offset=0, length=10, style="font", size="12", auto_format=False),
            MessageStyle(offset=10, length=len(reply_message.encode()) - 10, style="font", size="13", auto_format=False)
        ])
        return client.replyMessage(Message(text=reply_message, style=style_lamviec), message_object, thread_id, thread_type)

    if len(args) < 2:
        return client.replyMessage(Message(text="Insufficient arguments for betting."), message_object, thread_id, thread_type)

    bet_type = command  
    try:
        bet_amount = int(args[1])
    except ValueError:
        return client.replyMessage(Message(text="Sá»‘ tiá»n cÆ°á»£c khÃ´ng há»£p lá»‡. Vui lÃ²ng nháº­p má»™t sá»‘."), message_object, thread_id, thread_type)

    current_money = get_money(author_id)
    if current_money < 1000:
        return client.replyMessage(Message(text="Báº¡n cáº§n Ã­t nháº¥t 1000 VND Ä‘á»ƒ chÆ¡i tÃ i xá»‰u."), message_object, thread_id, thread_type)

    if bet_amount < 1000:
        return client.replyMessage(Message(text="Sá»‘ tiá»n cÆ°á»£c tá»‘i thiá»ƒu lÃ  1000 VND."), message_object, thread_id, thread_type)

    if bet_amount > current_money:
        return client.replyMessage(Message(text="Báº¡n khÃ´ng cÃ³ Ä‘á»§ tiá»n Ä‘á»ƒ Ä‘áº·t cÆ°á»£c."), message_object, thread_id, thread_type)

    try:
        response = requests.get("https://api.sumiproject.net/game/taixiu")
        if response.status_code == 200:
            data = response.json()
            total = data.get("total", None)
            result = data.get("result", "KhÃ´ng cÃ³ dá»¯ liá»‡u") 


            if total is None:
                return client.replyMessage(Message(text="No total value found in the API response."), message_object, thread_id, thread_type)

            image_directory = os.path.join(os.path.dirname(__file__), "taixiu")
            image_filename = f"{total}.jpg"
            image_path = os.path.join(image_directory, image_filename)

            if not os.path.exists(image_path):
                return client.replyMessage(Message(text=f"No image found for total {total}."), message_object, thread_id, thread_type)

            if bet_type == result:
                add_money(author_id, bet_amount)  
                content = f"Tá»•ng Ä‘iá»ƒm: {total}, Káº¿t quáº£: {result}. Báº¡n Ä‘Ã£ tháº¯ng cÆ°á»£c {bet_amount}!"
            else:
                subtract_money(author_id, bet_amount) 
                content = f"Tá»•ng Ä‘iá»ƒm: {total}, Káº¿t quáº£: {result}. Báº¡n Ä‘Ã£ thua cÆ°á»£c {bet_amount}."

            client.sendLocalImage(imagePath=image_path, thread_id=thread_id, thread_type=thread_type, message=Message(text=content))

        else:
            client.replyMessage(Message(text="KhÃ´ng thá»ƒ láº¥y ná»™i dung tá»« API."), message_object, thread_id, thread_type)

    except Exception as e:
        client.replyMessage(Message(text=f"Unexpected error: {e}"), message_object, thread_id, thread_type)
